<?xml version="1.0" encoding="utf-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="1" author="oulja">
        <createTable tableName="incident">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="titre" type="VARCHAR(255)"/>
            <column name="description" type="VARCHAR(255)"/>
            <column name="date_attribution" type="DATE"/>
            <column name="date_resolution" type="DATE"/>
            <column name="statut" type="VARCHAR(50)"/>
            <column name="priorite" type="VARCHAR(50)"/>
            <column name="gravite" type="VARCHAR(50)"/>

            <!-- Foreign keys -->
            <column name="service_id" type="INT"/>
            <column name="client_id" type="INT"/>
            <column name="coe_dev_id" type="INT"/>
        </createTable>

        <!-- Collection pour fichiers joints -->
        <createTable tableName="incident_fichier_joint">
            <column name="incident_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="fichier_joint" type="VARCHAR(255)"/>
        </createTable>

        <!-- Clé étrangère : incident -> service -->
        <addForeignKeyConstraint 
            baseTableName="incident"
            baseColumnNames="service_id"
            constraintName="fk_incident_service"
            referencedTableName="service_entity"
            referencedColumnNames="id"/>

        <!-- Clé étrangère : incident -> user (client) -->
        <addForeignKeyConstraint 
            baseTableName="incident"
            baseColumnNames="client_id"
            constraintName="fk_incident_client"
            referencedTableName="user_entity"
            referencedColumnNames="id"/>

        <!-- Clé étrangère : incident -> user (coeDev) -->
        <addForeignKeyConstraint 
            baseTableName="incident"
            baseColumnNames="coe_dev_id"
            constraintName="fk_incident_coedev"
            referencedTableName="user_entity"
            referencedColumnNames="id"/>

        <!-- Clé étrangère : fichiers joints -->
        <addForeignKeyConstraint 
            baseTableName="incident_fichier_joint"
            baseColumnNames="incident_id"
            constraintName="fk_fichier_joint_incident"
            referencedTableName="incident"
            referencedColumnNames="id"/>
    </changeSet>
</databaseChangeLog>
