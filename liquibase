"use client";

import React, { useState, useEffect, useRef } from "react";
import { useRouter } from "next/navigation";
import { toast, ToastContainer } from "react-toastify";
import "react-toastify/dist/ReactToastify.css";

import IncidentSummaryPopup from "@/app/view/create-incident/IncidentSummaryPopup";
import IncidentQuestions from "@/app/view/create-incident/IncidentQuestions";
import IncidentHeader from "@/app/view/create-incident/IncidentHeader";
import HeaderBar from "@/app/view/components/HeaderBar";
import Sidebar from "../SideBarComponent/SideBar";

import { Incident } from "@/app/models/Incident";
import { IncidentService } from "@/app/service/IncidentService";
import { IncidentPriority } from "@/app/utils/IncidentPriority";

interface Question {
  id: string;
  text: string;
  type: "text" | "textarea" | "radio" | "select" | "file" | "multitag";
  placeholder?: string;
  options?: string[];
}

const IncidentForm = () => {
  const router = useRouter();
  const [√©tape, set√âtape] = useState(1);
  const [r√©ponses, setR√©ponses] = useState<{ [key: string]: string | string[] | FileList | null }>({});
  const [sla, setSla] = useState("");
  const [priorit√©, setPriorit√©] = useState<IncidentPriority | "">("");
  const [afficherPopup, setAfficherPopup] = useState(false);
  const [champErreur, setChampErreur] = useState<string[]>([]);
  const [dateRapport] = useState(new Date().toLocaleString());
  const refs = useRef<{ [key: string]: HTMLDivElement | null }>({});
  const [transformedAnswers, setTransformedAnswers] = useState<{ [key: string]: string }>({});

  const questionsIncident: Question[] = [
    {
      id: "application",
      text: "Quel application est concern√© par l‚Äôincident ?",
      type: "select",
      options: ["BILL_PAYMENT", "Bankup", "Interop", "OpenR", "Cockpit"],
    },
    {
      id: "environment",
      text: "Quel est l‚Äôenvironnement affect√© ?",
      type: "radio",
      options: ["Dev", "HF", "HT", "Stabilisation"],
    },
    {
      id: "gravit√©",
      text: "Quel est l‚Äôeffet ou les cons√©quences de l‚Äôincident ? (impact)",
      type: "radio",
      options: ["Mineur", "Majeur", "Critique"],
    },
    {
      id: "tags",
      text: "Quels tags correspondent √† cet incident ?",
      type: "multitag",
      options: ["Bridge", "Transfert", "Elevy", "Account", "E-tax", "Guce"],
    },
    {
      id: "shortDescription",
      text: "Quel est l‚Äôobjet principal de l‚Äôincident ?",
      type: "text",
      placeholder: "Exemple : √âchec de l‚Äôauthentification via SSO",
    },
    {
      id: "details",
      text: "D√©crivez les d√©tails techniques de l‚Äôincident",
      type: "textarea",
      placeholder: "Expliquez les √©tapes, erreurs rencontr√©es et cons√©quences fonctionnelles",
    },
    {
      id: "attachments",
      text: "Ajoutez les fichiers n√©cessaires (logs, captures d‚Äô√©cran, etc.)",
      type: "file",
    },
  ];

  const totalQuestions = questionsIncident.length;
  const answeredCount = questionsIncident.filter((q) => {
    const val = r√©ponses[q.id];
    if (q.type === "file") return (val as FileList)?.length > 0;
    if (q.type === "multitag") return (val as string[])?.length > 0;
    return !!val;
  }).length;

  const progress = Math.round((answeredCount / totalQuestions) * 100);

  const g√©rerChangementR√©ponse = (id: string, valeur: string | string[] | FileList | null) => {
    setR√©ponses((prev) => ({ ...prev, [id]: valeur }));
    setChampErreur((prev) => prev.filter((champ) => champ !== id));
  };

  useEffect(() => {
    const gravite = r√©ponses["gravit√©"] as string;
    if (gravite) {
      const priorit√©Map: Record<string, IncidentPriority> = {
        "Critique": IncidentPriority.CRITIQUE,
        "Majeur": IncidentPriority.ELEVEE,
        "Mineur": IncidentPriority.MOYENNE,
      };
      const nouvellePriorit√© = priorit√©Map[gravite];
      setPriorit√©(nouvellePriorit√©);
      const slaMap: Record<IncidentPriority, string> = {
        [IncidentPriority.MOYENNE]: "8 heures",
        [IncidentPriority.ELEVEE]: "4 heures",
        [IncidentPriority.CRITIQUE]: "2 heures",
        [IncidentPriority.FAIBLE]: "24 heures",
      };
      setSla(slaMap[nouvellePriorit√©]);
    }
  }, [r√©ponses["gravit√©"]]);

  const handleSubmitClick = async () => {
    const champsManquants = questionsIncident.filter((q) => {
      const val = r√©ponses[q.id];
      if (q.type === "file") return !(val as FileList)?.length;
      if (q.type === "multitag") return !(val as string[])?.length;
      return !val;
    });

    if (champsManquants.length > 0) {
      const ids = champsManquants.map((q) => q.id);
      setChampErreur(ids);
      const firstId = ids[0];
      refs.current[firstId]?.scrollIntoView({ behavior: "smooth", block: "center" });
      toast.error("Veuillez remplir tous les champs.");
      return;
    }

    const transformed: { [key: string]: string } = {};
    for (const [key, val] of Object.entries(r√©ponses)) {
      if (typeof val === "string") {
        transformed[key] = val;
      } else if (val instanceof FileList) {
        transformed[key] = Array.from(val).map((f) => f.name).join(", ");
      } else if (Array.isArray(val)) {
        transformed[key] = val.join(", ");
      }
    }

    setTransformedAnswers(transformed);

    try {
      const formData = new FormData();
      formData.append("titre", transformed.shortDescription || "");
      formData.append("description", transformed.details || "");
      formData.append("gravite", transformed.gravit√© || "");
      formData.append("priorite", priorit√© || "");
      formData.append("clientIgg", localStorage.getItem("clientIgg") || "");
      formData.append("environnement", transformed.environment || "");
      formData.append("application", transformed.application || "");

      if (Array.isArray(r√©ponses.tags)) {
        r√©ponses.tags.forEach((tag) => {
          formData.append("tags[]", tag);
        });
      }

      const fichiers = r√©ponses["attachments"] as FileList;
      if (fichiers && fichiers.length > 0) {
        Array.from(fichiers).forEach((file) => {
          formData.append("files", file);
        });
      }

      // Simuler une r√©ponse avec un ID d'incident (remplacez par la vraie r√©ponse de l'API)
      const response = await IncidentService.createIncident(formData);
      const incidentId = response.id || BigInt(123); // Supposons que l'API renvoie un ID

      toast.success(
        <div>
          Incident cr√©√© avec r√©f√©rence avec succ√®s !{" "}
          <a
            href={`/incident/${incidentId}`}
            onClick={(e) => {
              e.preventDefault();
              router.push(`/incident/${incidentId}`);
              toast.dismiss(); // Ferme le toast apr√®s redirection
            }}
            className="text-blue-500 underline hover:text-blue-700"
          >
            Voir l'incident
          </a>
        </div>,
        {
          autoClose: 5000, // Ferme automatiquement apr√®s 5 secondes
        }
      );

      setAfficherPopup(true);
      setR√©ponses({});
    } catch (error) {
      console.error("Erreur lors de la cr√©ation de l'incident :", error);
      toast.error("Erreur lors de la cr√©ation de l'incident.");
    }
  };

  return (
    <div className="flex bg-gray-100 min-h-screen">
      <Sidebar />
      <div className="flex-1 flex flex-col">
        <HeaderBar />
        <div className="flex justify-center items-start p-10">
          <div className="w-full max-w-screen-2xl space-y-6">
            <IncidentHeader step={√©tape} progress={progress} />
            <div className="bg-white backdrop-blur-md rounded-2xl shadow-lg p-8">
              <IncidentQuestions
                questions={questionsIncident}
                answers={r√©ponses}
                onAnswerChange={g√©rerChangementR√©ponse}
                errorFields={champErreur}
                refs={refs}
              />
              {sla && (
                <div className="text-right text-sm text-gray-600 font-medium mt-4">
                  ‚è±Ô∏è SLA attribu√© : <span className="text-black font-bold">{sla}</span>
                </div>
              )}
              {priorit√© && (
                <div className="text-right text-sm text-gray-600 font-medium mt-2">
                  üìå Priorit√© calcul√©e : <span className="text-black font-bold">{priorit√©}</span>
                </div>
              )}
              <div className="mt-6 text-center">
                <button
                  onClick={handleSubmitClick}
                  className="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg shadow transition"
                >
                  Soumettre l‚Äôincident
                </button>
              </div>
            </div>
          </div>
        </div>

        <IncidentSummaryPopup
          visible={afficherPopup}
          onClose={() => setAfficherPopup(false)}
          answers={transformedAnswers}
          sla={sla}
          priorit√©={priorit√©}
          reportDate={dateRapport}
        />

        <ToastContainer />
      </div>
    </div>
  );
};

export default IncidentForm;

"use client";

import { ApplicationIncident } from "@/app/utils/ApplicationIncident";
import { EnvironmentIncident } from "@/app/utils/EnvironnemntIncident";
import { getPriorityStyle, IncidentPriority } from "@/app/utils/IncidentPriority";
import { getGravityStyle, IncidentGravity } from "@/app/utils/IncidentGravity";
import React, { useState } from "react";
import { FaDownload, FaTrashAlt, FaFile } from "react-icons/fa";
import { FiFile, FiUpload } from "react-icons/fi";

interface Question {
  id: string;
  text: string;
  type: "text" | "textarea" | "radio" | "select" | "file" | "multitag";
  placeholder?: string;
  options?: string[];
}

interface IncidentQuestionsProps {
  questions: Question[];
  answers: { [key: string]: string | string[] | FileList | null };
  onAnswerChange: (id: string, value: string | string[] | FileList | null) => void;
  errorFields: string[];
  refs: React.MutableRefObject<{ [key: string]: HTMLDivElement | null }>;
}

const IncidentQuestions = ({
  questions,
  answers,
  onAnswerChange,
  errorFields,
  refs,
}: IncidentQuestionsProps) => {
  const selectedEnv = answers["environment"];
  const isDevOrHF = selectedEnv === "DEV" || selectedEnv === "HF";

  const [currentPage, setCurrentPage] = useState(0);
  const [newTag, setNewTag] = useState("");
  const [customTags, setCustomTags] = useState<string[]>([]);

  const totalPages = 3;
  const questionsPerPage = Math.ceil(questions.length / totalPages);

  const toggleTag = (id: string, tag: string) => {
    const current = (answers[id] as string[]) || [];
    const updated = current.includes(tag)
      ? current.filter((t) => t !== tag)
      : [...current, tag];
    onAnswerChange(id, updated);
  };

  const handleAddTag = (id: string) => {
    const tag = newTag.trim();
    const existing = (questions.find((q) => q.id === id)?.options || []).concat(
      customTags
    );
    if (tag && !existing.includes(tag)) {
      setCustomTags([...customTags, tag]);
      const current = (answers[id] as string[]) || [];
      onAnswerChange(id, [...current, tag]);
      setNewTag("");
    }
  };

  const renderInput = (q: Question) => {
    const answer = answers[q.id];
    switch (q.type) {
      case "select":
        return (
          <select
            value={(answer as string) || ""}
            onChange={(e) => onAnswerChange(q.id, e.target.value)}
            className="w-full border text-lg border-gray-300 rounded-md py-2 px-2"
          >
            <option disabled value="">
              S√©lectionner une option
            </option>
            {q.options?.map((opt) => (
              <option key={opt} value={opt}>
                {opt}
              </option>
            ))}
          </select>
        );
      case "radio":
  let options;
  switch (q.id) {
    case "gravit√©":
      options = Object.keys(IncidentGravity);
      break;

    case "environment":
      options = Object.keys(EnvironmentIncident);
      break;
    case "application":
      options = Object.keys(ApplicationIncident);
      break;
    default:
      options = q.options || [];
  }
  return (
    <div className="flex flex-wrap justify-center gap-3 mt-2">
      {options.map((opt) => {
        const selected = answer === opt;
        return (
          <label
            key={opt}
            className={`w-48 text-center px-8 py-2 rounded-xl text-lg font-medium items-center border cursor-pointer transition ${
              selected
                ? "bg-red-100 border-red-500 text-red-700"
                : "bg-gray-50 border-gray-300 hover:bg-gray-100"
            }`}
          >
            <input
              type="radio"
              name={q.id}
              value={opt}
              checked={selected}
              onChange={(e) => onAnswerChange(q.id, e.target.value)}
              className="hidden"
            />
            {q.id === "gravit√©" ? IncidentGravity[opt as keyof typeof IncidentGravity] :
             q.id === "environment" ? EnvironmentIncident[opt as keyof typeof EnvironmentIncident] :
             q.id === "ClientName" ? ApplicationIncident[opt as keyof typeof ApplicationIncident] :
             opt}
          </label>
        );
      })}
    </div>
  );
        switch (q.id) {
          case "gravit√©":
            options = Object.values(IncidentGravity).map((value) =>
              value.toString()
            );
            break;
          case "priority":
            options = Object.values(IncidentPriority).map((value) =>
              value.toString()
            );
            break;
          case "applicationName":
            options = Object.values(ApplicationIncident).map((value) =>
              value.toString()
            );
            break;
          case "environment":
            options = Object.values(EnvironmentIncident).map((value) =>
              value.toString()
            );
            break;
          default:
            options = q.options || [];
        }
        return (
          <div className="flex flex-wrap justify-center gap-3 mt-2">
            {options.map((opt) => {
              const disabled =
                q.id === "severity" &&
                opt === IncidentGravity.CRITIQUE &&
                isDevOrHF;
              const selected = answer === opt;
              return (
                <label
                  key={opt}
                  className={`w-48 text-center px-8 py-2 rounded-xl text-lg font-medium items-center border cursor-pointer transition ${
                    disabled
                      ? "bg-gray-100 text-gray-400 cursor-not-allowed"
                      : selected
                      ? getGravityStyle(IncidentGravity[opt as keyof typeof IncidentGravity]) ||
                        getPriorityStyle(IncidentPriority[opt as keyof typeof IncidentPriority]) ||
                        "bg-red-100 border-red-500 text-red-700"
                      : "bg-gray-50 border-gray-300 hover:bg-gray-100"
                  }`}
                >
                  <input
                    type="radio"
                    name={q.id}
                    value={opt}
                    disabled={disabled}
                    checked={selected}
                    onChange={(e) => onAnswerChange(q.id, e.target.value)}
                    className="hidden"
                  />
                  {opt}
                </label>
              );
            })}
          </div>
        );
      case "multitag":
        const allTags = [...(q.options || []), ...customTags];
        const selectedTags = (answer as string[]) || [];

        return (
          <div className="mt-2 space-y-3">
            <div className="flex flex-wrap gap-3">
              {allTags.map((tag) => {
                const selected = selectedTags.includes(tag);
                return (
                  <button
                    key={tag}
                    type="button"
                    onClick={() => toggleTag(q.id, tag)}
                    className={`px-4 py-2 rounded-full border text-lg transition ${
                      selected
                        ? "bg-blue-100 text-blue-700 border-blue-500"
                        : "bg-gray-50 border-gray-300 hover:bg-gray-100"
                    }`}
                  >
                    #{tag}
                  </button>
                );
              })}
            </div>
            <div className="flex items-center gap-2">
              <input
                type="text"
                value={newTag}
                onChange={(e) => setNewTag(e.target.value)}
                placeholder="Ajouter un tag"
                className="flex-1 border border-gray-300 rounded-md py-3 px-4 text-lg"
              />
              <button
                type="button"
                onClick={() => handleAddTag(q.id)}
                className="text-blue-600 text-xl font-bold px-4 py-2 rounded-full border border-blue-500 hover:bg-blue-50"
                title="Ajouter un tag"
              >
                +
              </button>
            </div>
          </div>
        );
      case "text":
        return (
          <input
            type="text"
            value={(answer as string) || ""}
            placeholder={q.placeholder}
            onChange={(e) => onAnswerChange(q.id, e.target.value)}
            className="w-full mt-2 border border-gray-300 rounded-md py-3 px-4 text-lg"
          />
        );
      case "textarea":
        return (
          <textarea
            rows={4}
            value={(answer as string) || ""}
            placeholder={q.placeholder}
            onChange={(e) => onAnswerChange(q.id, e.target.value)}
            className="w-full mt-2 border border-gray-300 rounded-md py-3 px-4 text-lg"
          />
        );
      case "file":
        const fileList = answer as FileList | null;
        const maxSizeMB = 10;
        const firstFile = fileList && fileList[0];
        const fileTooLarge =
          firstFile && firstFile.size > maxSizeMB * 1024 * 1024;

        return (
          <div className="space-y-4 mt-2 text-lg">
            <label
              htmlFor={q.id}
              className="w-full border-2 border-dashed border-blue-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition"
            >
              <input
                id={q.id}
                type="file"
                multiple={false}
                className="hidden"
                onChange={(e) => onAnswerChange(q.id, e.target.files)}
              />
              <div className="flex flex-col items-center justify-center gap-3 p-6 rounded-xl border border-dashed border-gray-300 bg-white shadow-sm relative">
                <div className="relative flex items-center justify-center w-24 h-24 rounded-full bg-gray-100">
                  <FiFile className="text-4xl text-gray-400" />
                  <div className="absolute bottom-2 right-2 bg-blue-500 p-1 rounded-full">
                    <FiUpload className="text-white text-sm" />
                  </div>
                </div>
                <p className="text-gray-500">
                  Drag & drop ou{" "}
                  <span className="text-blue-600 underline cursor-pointer">
                    choisir un fichier
                  </span>
                </p>
                <p className="text-lg text-red-500">Taille max : {maxSizeMB}MB</p>
              </div>
            </label>

            {firstFile && (
              <div className="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg px-4 py-3">
                <div className="flex items-center gap-3">
                  <FaFile className="text-blue-500 text-lg" />
                  <div>
                    <p className="font-semibold text-gray-800">{firstFile.name}</p>
                    <p className="text-base text-gray-500">
                      {(firstFile.size / (1024 * 1024)).toFixed(2)} MB
                    </p>
                  </div>
                </div>
                <div className="flex items-center gap-3">
                  <button
                    type="button"
                    className="flex items-center gap-1 p-2 bg-white border rounded-full text-blue-600 hover:bg-blue-100"
                    title="T√©l√©charger"
                  >
                    <FaDownload />
                  </button>
                  <button
                    type="button"
                    onClick={() => onAnswerChange(q.id, null)}
                    className="p-2 bg-white border rounded-full text-red-600 hover:bg-red-100"
                    title="Supprimer"
                  >
                    <FaTrashAlt />
                  </button>
                </div>
              </div>
            )}

            {fileTooLarge && (
              <p className="text-red-600 text-lg font-medium">
                ‚ö†Ô∏è Le fichier d√©passe la taille maximale autoris√©e de {maxSizeMB}
                MB.
              </p>
            )}
          </div>
        );
      default:
        return null;
    }
  };

  const startIndex = currentPage * questionsPerPage;
  const paginatedQuestions = questions.slice(
    startIndex,
    startIndex + questionsPerPage
  );

  return (
    <div className="space-y-6 text-lg">
      {paginatedQuestions.map((q) => (
        <div
          key={q.id}
          ref={(el) => (refs.current[q.id] = el)}
          className={`bg-white p-6 rounded-xl shadow border ${
            errorFields.includes(q.id)
              ? "border-red-500 animate-shake"
              : "border-gray-200"
          }`}
        >
          <h3 className="text-xl font-semibold text-gray-800 mb-3">{q.text}</h3>
          {renderInput(q)}
        </div>
      ))}

      <div className="grid grid-cols-3 items-center pt-6 gap-4">
        <button
          onClick={() => setCurrentPage((prev) => Math.max(prev - 1, 0))}
          disabled={currentPage === 0}
          className={`justify-self-start px-4 py-2 rounded-lg font-semibold text-lg transition ${
            currentPage === 0
              ? "bg-gray-300 text-white cursor-not-allowed"
              : "bg-gray-600 text-white hover:bg-gray-700"
          }`}
        >
          ‚Üê Pr√©c√©dent
        </button>
        <span className="justify-self-center text-xl font-medium">
          Page {currentPage + 1} sur {totalPages}
        </span>
        <button
          onClick={() =>
            setCurrentPage((prev) => Math.min(prev + 1, totalPages - 1))
          }
          disabled={currentPage === totalPages - 1}
          className={`justify-self-end px-4 py-2 rounded-lg font-semibold text-lg transition ${
            currentPage === totalPages - 1
              ? "bg-gray-300 text-white cursor-not-allowed"
              : "bg-gray-600 text-white hover:bg-gray-700"
          }`}
        >
          Suivant ‚Üí
        </button>
      </div>
    </div>
  );
};

export default IncidentQuestions;
import { FileText, UserCheck } from 'lucide-react';

interface IncidentHeaderProps {
    step: number;
    progress: number; // 0 √† 100
}

const IncidentHeader = ({ step, progress }: IncidentHeaderProps) => {
    const isDeclaration = step === 1;

    return (
        <div className="bg-black/75 backdrop-blur-sm border border-gray-900 rounded-xl bg-white shadow-md py-6 px-6 flex flex-col items-center justify-center space-y-3">
            {/* Ic√¥ne rouge */}
            <div className="rounded-full bg-red-600 p-3 flex items-center justify-center">
                {isDeclaration ? (
                    <FileText className="h-7 w-7 text-white" />
                ) : (
                    <UserCheck className="h-7 w-7 text-white" />
                )}
            </div>

            {/* Titre en noir */}
            <h1 className="text-2xl font-semibold text-black px-4 py-1 rounded-md text-center">
                {isDeclaration ? "D√©claration d'Incident" : "Assigner l'Incident"}
            </h1>

            {/* Barre de progression */}
            <div className="w-full mt-2 bg-gray-300 rounded-full h-3 overflow-hidden">
                <div
                    className="h-full bg-red-500 transition-all duration-300"
                    style={{ width: `${progress}%` }}
                />
            </div>

            {/* Pourcentage en noir */}
            <p className="text-sm text-black mt-1">{progress}% compl√©t√©</p>
        </div>
    );
};

export default IncidentHeader;
